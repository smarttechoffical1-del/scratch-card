<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scratch-to-Reveal Sketch Card</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,'Noto Sans',Arial}
    body{margin:0;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#111;color:#eee}
    .card{width:320px;max-width:92vw;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.6);background:#222}
    .viewport{position:relative;width:100%;padding-top:75%;}
    .photo{position:absolute;inset:0;background-size:cover;background-position:center}
    canvas{position:absolute;inset:0;touch-action:none}
    .controls{display:flex;gap:.5rem;padding:.75rem}
    .controls button{flex:1;padding:.5rem;border-radius:8px;border:0;background:#0a84ff;color:white;cursor:pointer}
    .controls input{flex:2;padding:.5rem;border-radius:8px;border:1px solid #333;background:#111;color:#eee}
    .hint{padding:.6rem;font-size:.9rem;color:#bbb}
  </style>
</head>
<body>
  <div class="card">
    <div class="viewport">
      <div id="photo" class="photo"></div>
      <canvas id="mask"></canvas>
    </div>
    <div class="controls">
      <input id="imgUrl" placeholder="Photo URL (paste here)" />
      <button id="load">Load</button>
    </div>
    <div class="controls">
      <button id="reset">Reset</button>
      <button id="download">Download result</button>
    </div>
    <div class="hint">স্ক্র্যাচ/টাচ করে ছবি উন্মোচন করুন।</div>
  </div>

<script>
(function(){
  const photo = document.getElementById('photo');
  const canvas = document.getElementById('mask');
  const ctx = canvas.getContext('2d', { willReadFrequently: false });
  const input = document.getElementById('imgUrl');
  const loadBtn = document.getElementById('load');
  const resetBtn = document.getElementById('reset');
  const downloadBtn = document.getElementById('download');

  const defaultImage = 'https://images.unsplash.com/photo-1503023345310-bd7c1de61c7d?q=80&w=1200&auto=format&fit=crop';
  let imageUrl = defaultImage;
  let isDrawing = false;
  let last = {x:0,y:0};
  let brushSize = 36;

  function resize(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(dpr,dpr);
    fillMask();
  }

  function fillMask(){
    ctx.save();
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = '#bdbdbd';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.restore();
  }

  function setPhoto(url){
    imageUrl = url || defaultImage;
    photo.style.backgroundImage = `url('${imageUrl}')`;
  }

  function pointerDown(e){
    isDrawing = true;
    const p = getPos(e);
    last = p;
    scratchLine(p,p);
  }
  function pointerUp(e){ isDrawing = false }
  function pointerMove(e){
    if(!isDrawing) return;
    const p = getPos(e);
    scratchLine(last,p);
    last = p;
  }

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX ?? (e.touches && e.touches[0].clientX)) - rect.left;
    const y = (e.clientY ?? (e.touches && e.touches[0].clientY)) - rect.top;
    return {x,y};
  }

  function scratchLine(p1,p2){
    ctx.save();
    ctx.globalCompositeOperation = 'destination-out';
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.lineWidth = brushSize;
    ctx.beginPath();
    ctx.moveTo(p1.x,p1.y);
    ctx.lineTo(p2.x,p2.y);
    ctx.stroke();
    ctx.restore();
  }

  function resetMask(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    fillMask();
  }

  function downloadPhoto(){
    const rect = canvas.getBoundingClientRect();
    const out = document.createElement('canvas');
    out.width = rect.width;
    out.height = rect.height;
    const octx = out.getContext('2d');
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      octx.drawImage(img,0,0,out.width,out.height);
      const a = document.createElement('a');
      a.href = out.toDataURL('image/png');
      a.download = 'sketch-card.png';
      a.click();
    }
    img.src = imageUrl;
  }

  canvas.addEventListener('pointerdown', pointerDown);
  window.addEventListener('pointerup', pointerUp);
  canvas.addEventListener('pointermove', pointerMove);

  loadBtn.addEventListener('click', ()=>{
    const url = input.value.trim();
    if(!url) return alert('একটা ছবি URL দিন।');
    setPhoto(url);
    resetMask();
  });
  resetBtn.addEventListener('click', resetMask);
  downloadBtn.addEventListener('click', downloadPhoto);

  setPhoto(imageUrl);
  requestAnimationFrame(resize);
  window.addEventListener('resize', ()=>{
    clearTimeout(window._rsz);
    window._rsz = setTimeout(resize,120);
  });
})();
</script>
</body>
</html>
